
# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# [START anthos_config_management_multi_environments_kustomize_config_source_yaml_cloudbuild.yaml]
availableSecrets:
  secretManager:
  - env: GITHUB_USERNAME
    versionName: projects/${PROJECT_ID}/secrets/github-username/versions/1
  - env: GITHUB_TOKEN
    versionName: projects/${PROJECT_ID}/secrets/github-token/versions/1
  - env: GITHUB_EMAIL
    versionName: projects/${PROJECT_ID}/secrets/github-email/versions/1
steps:
- args:
  - -eEuo
  - pipefail
  - -c
  - "git clone https://github.com/$$GITHUB_USERNAME/foo-config-dev && \\\ncd foo-config-dev\
    \ \ngit config user.email $$GITHUB_EMAIL\ngit config user.name $$GITHUB_USERNAME\
    \ \ngit remote set-url origin https://$$GITHUB_USERNAME:$$GITHUB_TOKEN@github.com/$$GITHUB_USERNAME/foo-config-dev.git\n\
    cd ..\n\nkustomize build overlays/dev --output foo-config-dev/\ncd foo-config-dev\
    \ \n\nrm README.md \necho \"Update: ${SHORT_SHA}\" > README.md\n\ngit add . &&\
    \ \\\ngit commit -m \"Rendered: ${SHORT_SHA}\nBuilt from commit ${COMMIT_SHA}\
    \ of repository foo-config-source - main branch \nAuthor: $(git log --format='%an\
    \ <%ae>' -n 1 HEAD)\" && \\\ngit push origin main"
  entrypoint: bash
  id: Render foo-config-dev
  name: gcr.io/google-samples/cloudbuild-kustomize:latest
  secretEnv:
  - GITHUB_EMAIL
  - GITHUB_USERNAME
  - GITHUB_TOKEN
- args:
  - -eEuo
  - pipefail
  - -c
  - "git clone https://github.com/$$GITHUB_USERNAME/foo-config-prod\ncd foo-config-prod\n\
    git config user.email $$GITHUB_EMAIL\ngit config user.name $$GITHUB_USERNAME \n\
    git remote set-url origin https://$$GITHUB_USERNAME:$$GITHUB_TOKEN@github.com/$$GITHUB_USERNAME/foo-config-prod.git\n\
    cd ..\n\nkustomize build overlays/prod --output foo-config-prod/\ncd foo-config-prod\
    \ \n\nrm README.md \necho \"Update: ${SHORT_SHA}\" > README.md\n\ngit add . &&\
    \ \\\ngit commit -m \"Rendered: ${SHORT_SHA}\nBuilt from commit ${COMMIT_SHA}\
    \ of repository foo-config-source - main branch \nAuthor: $(git log --format='%an\
    \ <%ae>' -n 1 HEAD)\" && \\\ngit push origin main"
  entrypoint: bash
  id: Render foo-config-prod
  name: gcr.io/google-samples/cloudbuild-kustomize:latest
  secretEnv:
  - GITHUB_EMAIL
  - GITHUB_USERNAME
  - GITHUB_TOKEN
# [END anthos_config_management_multi_environments_kustomize_config_source_yaml_cloudbuild.yaml]
---
